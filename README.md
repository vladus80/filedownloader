# FileDownloader

Веб-приложение на PHP для загрузки файлов, генерации ссылок/формул для Google Таблиц и ведения истории загрузок по пользователям и проектам.

## Возможности

- Авторизация пользователей с хранением паролей через `password_hash`.
- Загрузка файлов через форму (в т.ч. drag&drop на главной странице).
- Проверка расширения, размера и MIME-типа загружаемых файлов.
- Генерация формулы `HYPERLINK(...)` для вставки в Google Sheets.
- История загрузок с фильтрами и пагинацией.
- Админ-панель:
  - управление пользователями;
  - управление проектами;
  - просмотр/фильтрация всех файлов;
  - экспорт CSV;
  - скачивание SQLite БД;
  - пересчёт формул при изменении `BASE_URL`;
  - сервисные операции (реинициализация БД, очистка папки `Accounts`).
- Светлая/тёмная тема интерфейса.

## Стек

- PHP (без фреймворка).
- SQLite (`database.db`).
- TailwindCSS (через CDN в шаблоне).

## Структура проекта

```text
.
├── index.php                # Главная страница загрузки
├── upload.php               # Обработчик загрузки
├── history.php              # История загрузок пользователя
├── admin.php                # Админ-панель
├── login.php                # Вход
├── auth.php                 # Сессии, CSRF, авторизация
├── functions.php            # Валидация/сохранение файлов и утилиты
├── database.php             # Работа с SQLite и инициализация схемы
├── config.php               # Конфигурация (BASE_URL, лимиты, пути)
├── install.php              # Первичная установка
├── includes/
│   ├── header.php
│   ├── footer.php
│   └── admin/
│       ├── admin_files.php
│       ├── admin_users.php
│       ├── admin_projects.php
│       └── admin_system.php
├── Accounts/                # Папка с загруженными файлами (создается автоматически)
└── database.db              # SQLite БД (создается при установке)
```

## Требования

- PHP 8.0+ (рекомендуется 8.1+).
- Расширения PHP:
  - `pdo_sqlite`
  - `sqlite3`
  - `mbstring`
  - `fileinfo` (желательно для строгой MIME-проверки)
- Веб-сервер (Apache/Nginx) с доступом на запись в директорию проекта (для `database.db`, `admin.log`, `Accounts/`).

## Быстрый старт

1. Скопируйте проект в директорию веб-сервера.
2. Проверьте/измените настройки в `config.php`:
   - `BASE_URL` (важно выставить ваш публичный URL для ссылок на файлы);
   - `MAX_FILE_SIZE`;
   - `ALLOWED_EXTENSIONS`;
   - `SESSION_LIFETIME`.
3. Откройте в браузере `install.php` (один раз).
4. Сохраните выданные логины/пароли.
5. Удалите или ограничьте доступ к `install.php` после установки.
6. Откройте `login.php` и войдите в систему.

## Конфигурация

Основные параметры в `config.php`:

- `BASE_URL` — базовый URL для генерации публичной ссылки файла.
- `UPLOAD_DIR` — путь к директории хранения файлов.
- `MAX_FILE_SIZE` — лимит размера загружаемого файла.
- `ALLOWED_EXTENSIONS` — список разрешённых расширений.
- `SESSION_NAME` и `SESSION_LIFETIME` — параметры сессии.
- `DB_PATH` — путь к SQLite базе.
- `FILES_PER_PAGE`, `ADMIN_FILES_PER_PAGE` — пагинация.
- `ADMIN_LOG_PATH` — путь к логу админ-действий.

## Безопасность (что уже есть)

- CSRF-токен для POST-действий.
- Подготовленные SQL-запросы (`PDO::prepare`).
- Проверка авторизации и роли администратора.
- Ограничение неудачных попыток входа (блокировка на 5 минут после 5 попыток).
- Проверка загружаемого файла:
  - код ошибки загрузки;
  - размер;
  - расширение;
  - MIME-тип.

## Эксплуатационные заметки

- При смене домена/пути обновите `BASE_URL` и выполните в админке «Пересчитать формулы».
- Если удалить файлы в `Accounts`, история в БД останется, но ссылки будут вести на отсутствующие файлы.
- При реинициализации БД все записи будут удалены.

## Проверка синтаксиса

```bash
php -l upload.php
for f in *.php includes/*.php; do php -l "$f"; done
```

## Рекомендации для production

- Закрыть `install.php` после первичной установки.
- Использовать HTTPS.
- Ограничить доступ к директории проекта на уровне веб-сервера.
- Настроить регулярный backup `database.db` и папки `Accounts/`.
- Периодически менять пароли админов.

## Лицензия

В репозитории лицензия явно не указана. При необходимости добавьте файл `LICENSE`.
